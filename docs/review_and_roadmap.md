# Комплексный аудит проекта «Доходометр» и Roadmap

Дата: 2025-08-14

Авторы (роли):
- Продукт (Product)
- Разработчик (Fullstack)
- Дизайнер (UX/UI)
- DevOps/Infra
- QA/Автотесты
- Security/Безопасность
- Legal/Комплаенс РФ
- Marketing/Коммуникации

## Области аудита
- Архитектура и код: backend (FastAPI), frontend (Next.js 14), структуры `backend/app/*`, `frontend/*`
- Аутентификация/Безопасность: JWT (HS512), 2FA (TOTP), rate limiting (slowapi), логи
- База данных/миграции: SQLAlchemy 2.x, Alembic, синхронный `database_sync`, дублирование с `database.py`
- Тесты: pytest (>=80% cov), Vitest/Playwright; конвейер в `.github/workflows/ci.yml`
- CI/CD/Качество: ruff/mypy/eslint/prettier, trivy/bandit, trufflehog; docker build тесты
- Инфра/Деплой: `deployment/docker-compose.production.yml` (Traefik, Postgres, Redis, Uptime), генераторы секретов
- Конфиги/ENV: `env.example`, `app/core/config.py` (строгая валидация для prod)
- UX/UI: страницы аутентификации, базовые экраны приложения
- Комплаенс РФ: флаги 152‑ФЗ/115‑ФЗ/173‑ФЗ, политика хранения, анонимизация

## Ключевые находки и риски
1) Frontend аутентификация неполная
   - `frontend/lib/auth/auth-context.tsx` — заглушка, нет реальных вызовов backend и сохранения токенов/refresh-логики.
   - `frontend/lib/api-client.ts` — токены берутся из `localStorage`, нет авто‑refresh по 401/expired, SSR-риски (доступ к storage).
   - `frontend/app/auth/login/page.tsx` ожидает 2FA через 422 с сообщением, backend возвращает 400 с текстом — несогласованность контрактов.

2) Backend аутентификация/2FA — частично не реализовано
   - `UserRepository.set_temp_2fa_secret`/`get_temp_2fa_secret` не реализованы (pass/None). Эндпоинты `/2fa/setup` и `/2fa/verify` не завершат поток корректно.
   - Чёрный список токенов (revocation): импортируются `init_token_blacklist`/`logout_user`, но нужна верификация наличия персистентного стора (Redis) и инициализации при старте.

3) База данных: дубли и потенциальная рассинхронизация
   - Есть `core/database_sync.py` (используется в API), и `core/database.py` со сборкой URL через `postgresql+asyncpg`, но с `create_engine` синхронным — потенциально некорректно/неиспользуется. Требуется конвергенция одного пути.

4) Скрипты качества
   - `.ci/lint.sh` содержит два скрипта, «склеенных» вместе (дублируется заголовок и логика). Требуется очистка, единое поведение и явные цели.

5) Несоответствие контрактов и UX
   - Сообщения/коды ошибок auth (2FA, 401/403/400) не синхронизированы между BE и FE.
   - Отсутствуют UX‑потоки для «восстановить пароль», «подтверждение email», «управление сессиями».

6) Тестовое покрытие
   - Недостаточно unit/integration тестов по auth/2FA/refresh/blacklist, мало FE‑тестов форм и перехватчиков axios.

7) Безопасность/логирование
   - Логи — текстовые; для прод желательно JSON‑структура и `request_id`, корреляция в Traefik/Prometheus.
   - Проверить CSP/Headers — в Traefik добавлены, на приложении — минимально.

8) Мелочи и долги
   - Untracked: `backend/app/admin_api/`, `backend/app/core/db.py` — синхронизировать с VCS/CI.
   - FE: централизованный обработчик 401/403 и редирект — есть, но без refresh.

## Рекомендации и решения
- FE auth: перейти на cookie (httpOnly) или надёжную стратегию хранения; реализовать refresh‑поток и синхронизацию с BE.
- BE 2FA: хранить временные секреты в Redis (TTL), завершить verify/enable, единые коды/сообщения.
- DB: выбрать единый модуль (sync для FastAPI текущей реализации или полноценный async), удалить/исправить лишний.
- Логи: JSON logging + `X-Request-ID`, сквозная корреляция с Traefik.
- Тесты: покрыть auth, refresh, 2FA, blacklist; FE — формы/перехватчики/redirect.
- CI: почистить `.ci/lint.sh`, оставить один вариант; усилить секрет‑скан (gitleaks) при необходимости.

## Пул задач (приоритизация)

### Срочные (ритм: 1–3 дня)
1. FE: реализовать `AuthProvider` с реальными вызовами `api.auth.login/register/refresh/me`, хранением токенов, auto‑refresh и SSR‑безопасностью; унифицировать обработку 401/403.
2. FE/BE: согласовать контракты 2FA (коды/сообщения/статусы: 400 vs 422), обновить фронтовую логику показа 2FA‑челленджа.
3. BE: реализовать `UserRepository.set_temp_2fa_secret/get_temp_2fa_secret` на Redis c TTL; проверить инициализацию blacklist.
4. DB: унифицировать модуль БД, удалить/исправить `core/database.py` или перевести на async последовательно.
5. CI: почистить `.ci/lint.sh` (удалить дубли), добавить явные таргеты; убедиться, что untracked пути добавлены в репозиторий.
6. Тесты: unit/integration по login/refresh/2FA/blacklist; FE — тесты формы логина и перехватчиков axios.

### Важные (1–2 недели)
7. Логирование: JSON‑формат, поля request_id/user_id/endpoint/latency; экспорт в Prometheus + Sentry.
8. RBAC: роли и зависимости на эндпоинтах; тесты авторизации.
9. UX: флоу восстановления пароля, управление сессиями, страница профиля безопасности; контент‑тексты.
10. Security hardening: ротация секретов, перечень секретов в секрет‑менеджере, политика смены ключей.

### Долгосрочные (3–8 недель)
11. Интеграции с брокерами (Tinkoff/Binance) — стабилизация SDK/квот, мок‑слои.
12. Продвинутая аналитика портфелей и налоговый модуль (демо уже есть) — расширить кейсы.
13. Деплой: canary/blue‑green, авто‑rollback по health/метрикам.

## Roadmap (этапы, сроки, ответственные)

Этап 0 — Стабилизация аутентификации (1–3 дня)
- Ответственные: Fullstack, QA, Security
- KPI: зелёные тесты auth/2FA/refresh, 0 критических багов, согласованные контракты FE/BE
- Задачи: 1–6

Этап 1 — Основания безопасности и наблюдаемость (1 неделя)
- Ответственные: Backend, DevOps, Security
- KPI: JSON‑логи, request_id, RBAC на критичных эндпоинтах, дашборды метрик/логов
- Задачи: 7–10

Этап 2 — UX и расширение возможностей (2–3 недели)
- Ответственные: Product, UX/UI, Fullstack
- KPI: завершённые флоу восстановления/сессий, улучшенные формы, рост конверсии входа
- Задачи: 9, 11–12

Этап 3 — Эксплуатация и деплой стратегии (параллельно, 2–4 недели)
- Ответственные: DevOps, Project Lead
- KPI: безопасные выкладки без даунтайма, время отката < 5 мин
- Задачи: 13

## Согласование со стратегией компании
- Быстрый и надёжный вход/безопасность — базис для дальнейшего роста (соответствует приоритетам).
- Интеграции и аналитика — следующий слой ценности.
- Инфраструктурные улучшения — снижение риска регрессий и ускорение релизов.

## Приложение: проверенные области (чек‑лист)
- [x] Backend API, security, конфиги
- [x] Frontend auth, API клиент, страницы
- [x] БД/миграции
- [x] Тесты (структура, пороги)
- [x] CI/CD (линтеры, сборки, сканирование)
- [x] Деплой/секреты/Traefik
- [x] Комплаенс РФ (флаги/политики)
- [x] Мониторинг/метрики

---

Подписи: Product, Fullstack, UX/UI, DevOps, QA, Security, Legal, Marketing


